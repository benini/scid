
trigger:
- master

jobs:
- job: ubuntu_latest
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - script: |
       sudo apt-get update &&
       sudo apt-get -y install tcl-dev tk-dev
    displayName: 'download tclt'
  - task: CMake@1
    inputs:
      workingDirectory: 'build'
      cmakeArgs: '-DGTEST=ON ..'
  - script: cmake --build build
  - script: build/gtest/scid_tests

- job: Windows_VS2019
  pool:
    vmImage: 'windows-latest'
  steps:
  - script: git clone --depth=1 https://github.com/microsoft/vcpkg.git
    displayName: Checkout vcpkg submodule
  - script: .\vcpkg\bootstrap-vcpkg.bat
    displayName: Bootstrap vcpkg
  - script: .\vcpkg\vcpkg.exe install tcl --triplet x64-windows --vcpkg-root .\vcpkg
    displayName: vcpkg install dependencies
  - script: mkdir build
    displayName: Make Build Directory
  - task: CMake@1
    inputs:
      workingDirectory: 'build'
      cmakeArgs: '-A x64 -DGTEST=ON -DCMAKE_TOOLCHAIN_FILE=../vcpkg/scripts/buildsystems/vcpkg.cmake ..'
  - task: MSBuild@1
    inputs:
      solution: 'build/ALL_BUILD.vcxproj'
      maximumCpuCount: true
      platform: 'x64'
      configuration: 'Release'
  - task: CopyFiles@2
    inputs:
      Contents: '**\$(BuildConfiguration)\**\?(*.exe|*.dll|*.pdb)'
      targetFolder: $(Build.ArtifactStagingDirectory)
  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: $(Build.ArtifactStagingDirectory)
      artifactName: MyBuildOutputs

- job: Windows_nmake
  pool:
    vmImage: 'windows-latest'
  steps:
  - script: |
      pushd "C:\Program Files (x86)\Microsoft Visual Studio\Installer\"
      for /f "delims=" %%x in ('.\vswhere.exe -latest -property InstallationPath') do set VSPATH=%%x
      popd
      call "%VSPATH%\VC\Auxiliary\Build\vcvarsall.bat" x64
      mkdir tcltk & cd tcltk
      git clone --branch core-8-6-10 https://github.com/tcltk/tcl.git
      cd tcl & cd win
      nmake -f makefile.vc INSTALLDIR=$(Build.SourcesDirectory)\tcltk
      nmake -f makefile.vc install INSTALLDIR=$(Build.SourcesDirectory)\tcltk
  - script: |
      pushd "C:\Program Files (x86)\Microsoft Visual Studio\Installer\"
      for /f "delims=" %%x in ('.\vswhere.exe -latest -property InstallationPath') do set VSPATH=%%x
      popd
      call "%VSPATH%\VC\Auxiliary\Build\vcvarsall.bat" x64
      set TCL_DIR=$(Build.SourcesDirectory)\tcltk
      mkdir build & cd build
      cmake -G"NMake Makefiles" ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_INSTALL_PREFIX=../install ^
            -DCMAKE_TOOLCHAIN_FILE=../vcpkg/scripts/buildsystems/vcpkg.cmake ^
             $(Build.SourcesDirectory)
      nmake /N install
      nmake install
    displayName: Generating with CMake
  - task: CopyFiles@2
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)\install'
      Contents: '**'
      TargetFolder: '$(build.artifactstagingdirectory)'
  - task: PublishBuildArtifacts@1    
    displayName: 'Publish Artifact: drop'
    inputs:
      PathtoPublish: '$(build.artifactstagingdirectory)'